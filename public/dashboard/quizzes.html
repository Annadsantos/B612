<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>B612 Dashboard - Quizzes</title>

    <link rel="stylesheet" href="../css/dashboards.css">
    <link rel="stylesheet" href="../css/estilo.css">
    <link rel="stylesheet" href="../css/quiz.css">

    <script src="../js/sessao.js"></script>
</head>

<body onload="validarSessao(); onloadEsconder()">

    <div class="janela">
        <div class="header-left">
            <h1>B612</h1>

            <div class="hello">
                <h3>Bem-vindo, <span id="b_usuario"></span> ao Aster√≥ide B612!</h3>
            </div>

            <div class="btn-nav-white"><a href="cards.html">
                    <h3>Aqu√°rios</h3>
                </a></div>
            <div class="btn-nav-white"><a href="quizzes.html">
                    <h3>Quizzes</h3>
                </a></div>
            <div class="btn-nav-white"><a href="dashboard.html">
                    <h3>Dashboard</h3>
                </a></div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>
        </div>

        <div class="dash">

            <div class="container-quiz-2">
                <img src="../assets/imgs/quiz1.jpeg">

                <div class="quiz-textos">
                    <h2>Qual conselho voc√™ precisa?</h2>
                    <p>Descubra qual personagem tem a mensagem ideal para voc√™.</p>
                    <button id="btnIniciarConselho" onclick="btniniciar()">iniciar</button>
                </div>
            </div>

            <div id="pontuacaoConselhoEJogo">
                <div id="pontuacaoConselho">
                    <p>Pontos Raposa: <span id="spanRaposa">0</span></p>
                    <p>Pontos Rosa: <span id="spanRosa">0</span></p>
                    <p>Pontos Aviador: <span id="spanAviador">0</span></p>
                </div>
            </div>

            <div id="jogo_conselho" class="width-fit-content flex-colunar border-secondary" style="display:none">
                <div id="infoQuestaoConselho" class="padding-8">
                    <span>Quest√£o atual: <span id="spanNumeroConselho"></span> de <span
                            id="qtdQuestoesConselho"></span>.</span>
                </div>

                <div id="perguntaConselho" class="padding-8">
                    <span id="spanQuestaoConselho" class="text-bold"></span>
                </div>

                <div id="infoAlternativasConselho" class="padding-8">
                    <span><em>Escolha uma op√ß√£o:</em></span>
                </div>

                <div id="opcoesConselho" class="flex-colunar padding-8">
                    <span><input type="radio" id="primeiraOpcaoConselho" name="optionConselho"
                            value="alternativaA"><label id="labelConselhoUm" for="primeiraOpcaoConselho"></label></span>
                    <span><input type="radio" id="segundaOpcaoConselho" name="optionConselho"
                            value="alternativaB"><label id="labelConselhoDois"
                            for="segundaOpcaoConselho"></label></span>
                    <span><input type="radio" id="terceiraOpcaoConselho" name="optionConselho"
                            value="alternativaC"><label id="labelConselhoTres"
                            for="terceiraOpcaoConselho"></label></span>
                    <span><input type="radio" id="quartaOpcaoConselho" name="optionConselho" value="alternativaD"><label
                            id="labelConselhoQuatro" for="quartaOpcaoConselho"></label></span>
                </div>

                <div id="botoesConselho" class="flex-colunar padding-8">
                    <button onclick="submeterConselho()" id="btnSubmeterConselho">submeter</button>
                    <button onclick="avancarConselho()" id="btnProxConselho" disabled>pr√≥xima</button>
                    <button onclick="tentarNovamente()" id="btnTentarNovamente">tentar novamente</button>
                </div>
            </div>

            <div id="resultado_conselho" class="flex-colunar padding-8" style="display:none">
                <h2 id="resultadoConselhoTitulo"></h2>
                <p id="resultadoConselhoTexto"></p>
            </div>

            <div class="container-quiz-2">
                <img src="../assets/imgs/quiz2.jpg">

                <div class="quiz-textos">
                    <h2>Voc√™ se lembra da hist√≥ria?</h2>
                    <p>O quanto voc√™ se lembra de O Pequeno Pr√≠ncipe?</p>
                    <button id="btnIniciarQuiz" onclick="iniciarQuiz()">iniciar</button>
                </div>
            </div>

            <div id="pontuacaoEJogo">
                <div id="pontuacao">
                    <p>Acertos: <span id="spanCertas">0</span></p>
                    <p>Erros: <span id="spanErradas">0</span></p>
                    <p>Pontua√ß√£o: <span id="spanPontuacaoFinal">***</span></p>
                    <p id="msgFinal" class="msgFinal">***</p>
                </div>
            </div>

            <div id="jogo">
                <div id="infoQuestao" class="padding-8">
                    <span>Quest√£o atual: <span id="spanNumeroDaQuestaoAtual"></span> de <span
                            id="qtdQuestoes"></span></span>
                </div>

                <div id="perguntaDaQuestaoAtual" class="padding-8">
                    <span id="spanQuestaoExibida" class="text-bold"></span>
                </div>

                <div id="infoAlternativas" class="padding-8">
                    <span><em>Escolha uma op√ß√£o:</em></span>
                </div>

                <div id="opcoes" class="flex-colunar padding-8">
                    <span><input type="radio" id="primeiraOpcao" name="option" value="alternativaA"><label
                            id="labelOpcaoUm" for="primeiraOpcao"></label></span>
                    <span><input type="radio" id="segundaOpcao" name="option" value="alternativaB"><label
                            id="labelOpcaoDois" for="segundaOpcao"></label></span>
                    <span><input type="radio" id="terceiraOpcao" name="option" value="alternativaC"><label
                            id="labelOpcaoTres" for="terceiraOpcao"></label></span>
                    <span><input type="radio" id="quartaOpcao" name="option" value="alternativaD"><label
                            id="labelOpcaoQuatro" for="quartaOpcao"></label></span>
                </div>

                <div id="botoes" class="flex-colunar padding-8">
                    <button onclick="submeter()" id="btnSubmeter">submeter</button>
                    <button onclick="avancar()" id="btnProx" disabled>pr√≥xima</button>
                    <button onclick="tentarNovamente()" id="btnTentarNovamente">tentar novamente</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const listaDeQuestoesConselho = [
            {
                pergunta: "Como voc√™ tem se sentido nos √∫ltimos dias?",
                alternativaA: "Buscando me conectar mais com as pessoas",
                resultadoA: "raposa",
                alternativaB: "Cansado(a) e precisando de descanso emocional",
                resultadoB: "rosa",
                alternativaC: "Confuso(a) sobre qual caminho seguir",
                resultadoC: "aviador",
                alternativaD: "Um pouco de tudo isso",
                resultadoD: "rosa"
            },
            {
                pergunta: "O que tem sido mais dif√≠cil para voc√™ ultimamente?",
                alternativaA: "Entender meus relacionamentos",
                resultadoA: "raposa",
                alternativaB: "Lidar com expectativas dos outros",
                resultadoB: "rosa",
                alternativaC: "Manter meus sonhos vivos",
                resultadoC: "aviador",
                alternativaD: "Tomar decis√µes importantes",
                resultadoD: "aviador"
            },
            {
                pergunta: "Qual dessas frases combina mais com voc√™ hoje?",
                alternativaA: "Quero compreender melhor as pessoas ao meu redor.",
                resultadoA: "raposa",
                alternativaB: "Quero ser tratado(a) com mais cuidado e respeito.",
                resultadoB: "rosa",
                alternativaC: "Quero coragem para seguir meus projetos.",
                resultadoC: "aviador",
                alternativaD: "Quero me sentir menos sozinho(a).",
                resultadoD: "raposa"
            },
            {
                pergunta: "Como voc√™ reage quando algo n√£o sai como esperado?",
                alternativaA: "Tento entender e conversar sobre o que aconteceu.",
                resultadoA: "raposa",
                alternativaB: "Fico magoado(a) e preciso de tempo para me recompor.",
                resultadoB: "rosa",
                alternativaC: "Procuro reinventar uma solu√ß√£o diferente.",
                resultadoC: "aviador",
                alternativaD: "Finjo que est√° tudo bem, mas guardo pra mim.",
                resultadoD: "rosa"
            },
            {
                pergunta: "O que voc√™ mais quer no momento?",
                alternativaA: "Fortalecer minhas rela√ß√µes.",
                resultadoA: "raposa",
                alternativaB: "Reconhecer meu pr√≥prio valor.",
                resultadoB: "rosa",
                alternativaC: "Coragem para seguir meus sonhos.",
                resultadoC: "aviador",
                alternativaD: "Encontrar um novo sentido para as coisas.",
                resultadoD: "aviador"
            }
        ];

        let indiceQuestaoConselho = 0;
        let pontosRaposa = 0;
        let pontosRosa = 0;
        let pontosAviador = 0;
        const quantidadeQuestoesConselho = listaDeQuestoesConselho.length;

        function btniniciar() {
            document.getElementById('jogo_conselho').style.display = "flex";
            document.getElementById('btnIniciarConselho').style.display = "none";
            document.getElementById('qtdQuestoesConselho').innerHTML = quantidadeQuestoesConselho;
            preencherQuestaoConselho(0);
            btnSubmeterConselho.disabled = false;
            btnProxConselho.disabled = true;
        }

        function preencherQuestaoConselho(index) {
            habilitarAlternativasConselho(true);
            const questaoAtual = listaDeQuestoesConselho[index];
            indiceQuestaoConselho = index;

            document.getElementById("spanNumeroConselho").innerHTML = index + 1;
            document.getElementById("spanQuestaoConselho").innerHTML = questaoAtual.pergunta;
            document.getElementById("labelConselhoUm").innerHTML = questaoAtual.alternativaA;
            document.getElementById("labelConselhoDois").innerHTML = questaoAtual.alternativaB;
            document.getElementById("labelConselhoTres").innerHTML = questaoAtual.alternativaC;
            document.getElementById("labelConselhoQuatro").innerHTML = questaoAtual.alternativaD;
        }

        function habilitarAlternativasConselho(ativar) {
            primeiraOpcaoConselho.disabled = !ativar;
            segundaOpcaoConselho.disabled = !ativar;
            terceiraOpcaoConselho.disabled = !ativar;
            quartaOpcaoConselho.disabled = !ativar;
        }

        function submeterConselho() {
            const options = document.getElementsByName("optionConselho");

            let selecionada = null;
            for (let i = 0; i < options.length; i++) {
                if (options[i].checked) {
                    selecionada = options[i].value;
                    break;
                }
            }

            if (!selecionada) {
                alert("Escolha uma op√ß√£o.");
                return;
            }

            const questaoAtual = listaDeQuestoesConselho[indiceQuestaoConselho];

            let resultado = null;
            if (selecionada === "alternativaA") resultado = questaoAtual.resultadoA;
            if (selecionada === "alternativaB") resultado = questaoAtual.resultadoB;
            if (selecionada === "alternativaC") resultado = questaoAtual.resultadoC;
            if (selecionada === "alternativaD") resultado = questaoAtual.resultadoD;

            if (resultado === "raposa") pontosRaposa++;
            if (resultado === "rosa") pontosRosa++;
            if (resultado === "aviador") pontosAviador++;

            btnSubmeterConselho.disabled = true;
            btnProxConselho.disabled = false;

            habilitarAlternativasConselho(false);
        }

        function avancarConselho() {
            btnProxConselho.disabled = true;
            btnSubmeterConselho.disabled = false;

            desmarcarRadioConselho();

            if (indiceQuestaoConselho < quantidadeQuestoesConselho - 1) {
                preencherQuestaoConselho(indiceQuestaoConselho + 1);
            } else {
                finalizarQuizConselho();
            }
        }

        function desmarcarRadioConselho() {
            const options = document.getElementsByName("optionConselho");
            for (let i = 0; i < options.length; i++) {
                options[i].checked = false;
            }
        }

        function finalizarQuizConselho() {
            let conselhoFinal = "";
            let mensagem = "";
            let idPersonagem = null;

            if (pontosRaposa >= pontosRosa && pontosRaposa >= pontosAviador) {
                conselhoFinal = "Conselho da Raposa";
                mensagem = "‚ÄúVoc√™ se torna eternamente respons√°vel por aquilo que cativa.‚Äù<br>Talvez voc√™ precise olhar com carinho para os la√ßos que est√° criando e cultivando.";
                idPersonagem = 1;
            } else if (pontosRosa >= pontosRaposa && pontosRosa >= pontosAviador) {
                conselhoFinal = "Conselho da Rosa";
                mensagem = "‚Äú√â preciso exigir de cada um o que cada um pode dar.‚Äù<br>Talvez seja hora de cuidar de si e colocar limites gentis ao seu redor.";
                idPersonagem = 2;
            } else {
                conselhoFinal = "Conselho do Aviador";
                mensagem = "‚ÄúS√≥ se v√™ bem com o cora√ß√£o. O essencial √© invis√≠vel aos olhos.‚Äù<br>Talvez voc√™ precise confiar mais nos seus sonhos e na sua imagina√ß√£o.";
                idPersonagem = 3;
            }

            document.getElementById("resultadoConselhoTitulo").innerHTML = conselhoFinal;
            document.getElementById("resultadoConselhoTexto").innerHTML = mensagem;

            document.getElementById("jogo_conselho").style.display = "none";
            document.getElementById("resultado_conselho").style.display = "block";

            salvarResultadoConselho(conselhoFinal, idPersonagem);
        }

        function salvarResultadoConselho(conselhoFinal, idPersonagem) {
            console.log("Vou salvar no banco:", conselhoFinal, "personagem:", idPersonagem);

            var fkQuiz = 1;
            var fkUsuario = sessionStorage.ID_USUARIO;

            if (!fkUsuario) {
                console.error("ID_USUARIO n√£o encontrado na sessionStorage");
                return;
            }

            fetch("/quizzes/salvarResultado", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    fkQuiz: fkQuiz,
                    fkUsuario: fkUsuario,
                    conselho: conselhoFinal,
                    fkPersonagem: idPersonagem
                })
            })
                .then(function (resposta) {
                    console.log("Status da resposta:", resposta.status);
                    if (resposta.ok) {
                        return resposta.json();
                    } else {
                        throw "Erro ao salvar resultado. Status: " + resposta.status;
                    }
                })
                .then(function (dados) {
                    console.log("Dados retornados:", dados);
                })
                .catch(function (erro) {
                    console.error("Erro no fetch:", erro);
                });
        }


        function tentarNovamenteConselho() {
            window.location.reload();
        }

        const listaDeQuestoes = [
            {
                pergunta: "O que o Pequeno Pr√≠ncipe fazia em seu planeta antes de viajar?",
                alternativaA: "Cuidava de sua rosa",
                alternativaB: "Ca√ßava estrelas",
                alternativaC: "Constru√≠a avi√µes",
                alternativaD: "Visitava planetas vizinhos diariamente",
                alternativaCorreta: "alternativaA"
            },
            {
                pergunta: "Qual era o maior medo da rosa?",
                alternativaA: "Ser esquecida",
                alternativaB: "Os baob√°s",
                alternativaC: "O vento",
                alternativaD: "Os tigres",
                alternativaCorreta: "alternativaB"
            },
            {
                pergunta: "Quem ensina ao Pequeno Pr√≠ncipe o verdadeiro significado de cativar?",
                alternativaA: "A serpente",
                alternativaB: "A rosa",
                alternativaC: "A raposa",
                alternativaD: "O rei",
                alternativaCorreta: "alternativaC"
            },
            {
                pergunta: "Por que o aviador caiu no deserto do Saara?",
                alternativaA: "Foi levado por uma tempestade",
                alternativaB: "Seu avi√£o quebrou",
                alternativaC: "Ele queria encontrar o Pequeno Pr√≠ncipe",
                alternativaD: "Ele fazia um mapa do deserto",
                alternativaCorreta: "alternativaB"
            },
            {
                pergunta: "Segundo a raposa, o que √© essencial?",
                alternativaA: "A for√ßa",
                alternativaB: "O dinheiro",
                alternativaC: "O amor",
                alternativaD: "O invis√≠vel aos olhos",
                alternativaCorreta: "alternativaD"
            }
        ];

        let numeroDaQuestaoAtual = 0;
        let pontuacaoFinal = 0;
        let tentativaIncorreta = 0;
        let certas = 0;
        let erradas = 0;
        let quantidadeDeQuestoes = listaDeQuestoes.length;

        function onloadEsconder() {
            document.getElementById('pontuacao').style.display = "none";
            document.getElementById('jogo').style.display = "none";
        }

        function iniciarQuiz() {
            document.getElementById('pontuacao').style.display = "none";
            document.getElementById('jogo').style.display = "flex";
            document.getElementById('btnIniciarQuiz').style.display = "none";

            document.getElementById('qtdQuestoes').innerHTML = quantidadeDeQuestoes;

            preencherHTMLcomQuestaoAtual(0);

            btnSubmeter.disabled = false;
            btnProx.disabled = true;
            btnTentarNovamente.disabled = true;
        }

        function preencherHTMLcomQuestaoAtual(index) {
            habilitarAlternativas(true);
            const questaoAtual = listaDeQuestoes[index];
            numeroDaQuestaoAtual = index;

            document.getElementById("spanNumeroDaQuestaoAtual").innerHTML = Number(index) + 1;
            document.getElementById("spanQuestaoExibida").innerHTML = questaoAtual.pergunta;
            document.getElementById("labelOpcaoUm").innerHTML = questaoAtual.alternativaA;
            document.getElementById("labelOpcaoDois").innerHTML = questaoAtual.alternativaB;
            document.getElementById("labelOpcaoTres").innerHTML = questaoAtual.alternativaC;
            document.getElementById("labelOpcaoQuatro").innerHTML = questaoAtual.alternativaD;
        }

        function submeter() {
            const options = document.getElementsByName("option");

            let hasChecked = false;
            for (let i = 0; i < options.length; i++) {
                if (options[i].checked) {
                    hasChecked = true;
                    break;
                }
            }

            if (!hasChecked) {
                alert("N√£o h√° alternativas escolhidas. Escolha uma op√ß√£o.");
            } else {
                btnSubmeter.disabled = true;
                btnProx.disabled = false;

                habilitarAlternativas(false);

                checarResposta();
            }
        }

        function habilitarAlternativas(trueOrFalse) {
            let opcaoEscolhida = trueOrFalse ? false : true;

            primeiraOpcao.disabled = opcaoEscolhida;
            segundaOpcao.disabled = opcaoEscolhida;
            terceiraOpcao.disabled = opcaoEscolhida;
            quartaOpcao.disabled = opcaoEscolhida;
        }

        function avancar() {
            btnProx.disabled = true;
            btnSubmeter.disabled = false;

            desmarcarRadioButtons();

            numeroDaQuestaoAtual++;

            if (numeroDaQuestaoAtual < quantidadeDeQuestoes) {
                preencherHTMLcomQuestaoAtual(numeroDaQuestaoAtual);
            } else {
                finalizarJogo();
            }
            limparCoresBackgroundOpcoes();
        }

        function tentarNovamente() {
            window.location.reload();
        }

        function checarResposta() {
            const questaoAtual = listaDeQuestoes[numeroDaQuestaoAtual];
            const respostaQuestaoAtual = questaoAtual.alternativaCorreta;

            const options = document.getElementsByName("option");

            let alternativaCorreta = null;

            options.forEach((option) => {
                if (option.value === respostaQuestaoAtual) {
                    alternativaCorreta = option.labels[0].id;
                }
            });

            options.forEach((option) => {
                if (option.checked === true && option.value === respostaQuestaoAtual) {
                    document.getElementById(alternativaCorreta).classList.add("text-success-with-bg");
                    pontuacaoFinal++;
                    certas++;
                    document.getElementById("spanCertas").innerHTML = certas;

                } else if (option.checked && option.value !== respostaQuestaoAtual) {
                    const wrongLabelId = option.labels[0].id;

                    document.getElementById(wrongLabelId).classList.add("text-danger-with-bg");
                    document.getElementById(alternativaCorreta).classList.add("text-success-with-bg");
                    tentativaIncorreta++;
                    erradas++;
                    document.getElementById("spanErradas").innerHTML = erradas;
                }
            });
        }

        function limparCoresBackgroundOpcoes() {
            const options = document.getElementsByName("option");
            options.forEach((option) => {
                document.getElementById(option.labels[0].id).classList.remove("text-danger-with-bg");
                document.getElementById(option.labels[0].id).classList.remove("text-success-with-bg");
            });
        }

        function desmarcarRadioButtons() {
            const options = document.getElementsByName("option");
            for (let i = 0; i < options.length; i++) {
                options[i].checked = false;
            }
        }

        function finalizarJogo() {
            let textoParaMensagemFinal = null;
            let classComCoresParaMensagemFinal = null;
            const porcentagemFinalDeAcertos = pontuacaoFinal / quantidadeDeQuestoes;

            const percentual = Math.round(porcentagemFinalDeAcertos * 100);

            if (porcentagemFinalDeAcertos <= 0.3) {
                textoParaMensagemFinal = "Parece que voc√™ n√£o estudou...";
                classComCoresParaMensagemFinal = "text-danger-with-bg";
            }
            else if (porcentagemFinalDeAcertos > 0.3 && porcentagemFinalDeAcertos < 0.9) {
                textoParaMensagemFinal = "Pode melhorar na pr√≥xima, hein!";
                classComCoresParaMensagemFinal = "text-warning-with-bg";
            }
            else if (porcentagemFinalDeAcertos >= 0.8) {
                textoParaMensagemFinal = "Uau, parab√©ns!";
                classComCoresParaMensagemFinal = "text-success-with-bg";
            }
            else if (porcentagemFinalDeAcertos >= 0.9) {
                textoParaMensagemFinal = "Uau, parab√©ns!";
                classComCoresParaMensagemFinal = "text-success-with-bg";
            }

            textoParaMensagemFinal += `<br> Voc√™ acertou ${percentual}% das quest√µes.`;

            document.getElementById('msgFinal').innerHTML = textoParaMensagemFinal;
            document.getElementById('msgFinal').classList.add(classComCoresParaMensagemFinal);
            document.getElementById('spanPontuacaoFinal').innerHTML = pontuacaoFinal;

            document.getElementById('jogo').classList.add("text-new-gray");

            btnProx.disabled = true;
            btnSubmeter.disabled = true;
            btnTentarNovamente.disabled = false;

            document.getElementById('pontuacao').style.display = "block";

            salvarResultadoQuiz2(pontuacaoFinal, percentual);
        }

        function salvarResultadoQuiz2(pontuacaoFinal, percentual) {
            console.log("Salvando resultado do Quiz 2 no banco...");

            var fkQuiz = 2;
            var fkUsuario = sessionStorage.ID_USUARIO;

            if (!fkUsuario) {
                console.error("ID_USUARIO n√£o encontrado na sessionStorage");
                return;
            }

            var textoResultado = `Quiz mem√≥ria: ${pontuacaoFinal} acertos (${percentual}%)`;

            // TROCAR AQUI üëá
            fetch("/quizzes/salvarResultado", {   // <-- plural, igual ao app.use("/quizzes", ...)
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    fkQuiz: fkQuiz,
                    fkUsuario: fkUsuario,
                    conselho: textoResultado
                })
            })
                .then(function (resposta) {
                    console.log("Status da resposta (quiz 2):", resposta.status);
                    if (resposta.ok) {
                        return resposta.json();
                    } else {
                        throw "Erro ao salvar resultado do quiz 2. Status: " + resposta.status;
                    }
                })
                .then(function (dados) {
                    console.log("Dados retornados (quiz 2):", dados);
                })
                .catch(function (erro) {
                    console.error("Erro no fetch do quiz 2:", erro);
                });
        }
    </script>
</body>

</html>