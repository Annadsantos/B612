<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard B612</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../css/dashboards.css">
    <script src="../js/sessao.js"></script>
</head>

<body onload="obterDados()">
    <div class="janela">
        <div class="header-left">
            <h1>B612</h1>

            <div class="hello">
                <h3>Bem-vindo, <span id="b_usuario"></span> ao Asteróide B612!</h3>
            </div>

            <div class="btn-nav-white"><a href="quizzes.html">
                    <h3>quizzes</h3>
                </a></div>
            <div class="btn-nav-white"><a href="dashboard.html">
                    <h3>dashboard</h3>
                </a></div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>sair</h3>
            </div>
        </div>

        <div class="conteudo">
            <div class="kpis-container">
                <div id="kpiEssenciaInfantil" class="kpi"></div>
                <div id="kpiQuizResumo" class="kpi"></div>
                <div id="kpiMaisConselho" class="kpi"></div>
            </div>

            <div class="graficos-container">
                <canvas id="graficoQuiz2"></canvas>
                <canvas id="graficoImagem"></canvas>
                <canvas id="graficoConselhos"></canvas>
            </div>
        </div>
    </div>
    <script>
        if (sessionStorage.NOME_USUARIO) {
            document.getElementById("b_usuario").innerHTML = sessionStorage.NOME_USUARIO;
        }

        function obterDados() {
            fetch("/dashboard/respostasImagem")
                .then(function (res) {
                    if (!res.ok) {
                        console.log("Erro ao buscar respostasImagem. Status: " + res.status);
                    }
                    return res.json();
                })
                .then(function (dados) {
                    console.log("Respostas imagem:", dados);
                    plotarGraficoImagem(dados);
                })
                .catch(function (erro) {
                    console.error(erro);
                });

            fetch("/dashboard/quiz2Resumo")
                .then(function (res) {
                    if (!res.ok) {
                        console.log("Erro ao buscar quiz2Resumo: " + res.status);
                    }
                    return res.json();
                })
                .then(function (dados) {
                    console.log("Dados quiz2Resumo (front):", dados);
                    plotarGraficoQuiz2(dados);
                })
                .catch(function (erro) {
                    console.error(erro);
                });

            fetch("/dashboard/conselhosQuiz1")
                .then(function (res) {
                    if (!res.ok) {
                        console.log("Erro ao buscar conselhosQuiz1: " + res.status);
                    }
                    return res.json();
                })
                .then(function (dados) {
                    console.log("Dados conselhosQuiz1 (front):", dados);
                    plotarGraficoConselhos(dados);
                });
        }

        function plotarGraficoImagem(dados) {
            var canvas = document.getElementById('graficoImagem');
            if (!canvas) {
                console.error("Canvas graficoImagem não encontrado");
                return;
            }

            var ctx = canvas.getContext('2d');

            var labels = [];
            var valores = [];
            var total = 0;
            var qtdJiboia = 0;

            for (var i = 0; i < dados.length; i++) {
                var linha = dados[i];
                labels.push(linha.resposta);
                valores.push(linha.qtd);
                total += linha.qtd;

                if (linha.resposta && linha.resposta.toLowerCase() == "jiboia") {
                    qtdJiboia = linha.qtd;
                }
            }

            var percentual = 0;
            if (total > 0) {
                percentual = ((qtdJiboia / total) * 100).toFixed(1);
            }

            var kpi1 = document.getElementById("kpiEssenciaInfantil");
            if (kpi1) {
                kpi1.innerHTML = `essência infantil ${percentual}%`;
            }

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Respostas da imagem',
                        data: valores,
                        backgroundColor: ['#FFC8A2', '#C3C7D7']
                    }]
                }
            });
        }

        function plotarGraficoQuiz2(dados) {
            console.log("Chegou no plotarGraficoQuiz2:", dados);

            var acima = Number(dados.acima50 || 0);
            var abaixo = Number(dados.abaixo50 || 0);

            console.log("Valores usados no gráfico – acima:", acima, "abaixo:", abaixo);

            var total = acima + abaixo;
            var percentualAcima = 0;

            if (total > 0) {
                percentualAcima = ((acima / total) * 100).toFixed(1);
            }

            var kpi2 = document.getElementById("kpiQuizResumo");
            if (kpi2) {
                kpi2.innerHTML = `percentual de acertos acima da metade ${percentualAcima}%`;
            }

            var canvas = document.getElementById('graficoQuiz2');

            var ctx = canvas.getContext('2d')

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Acima de 50%', 'Abaixo de 50%'],
                    datasets: [{
                        label: 'Quantidade de envios',
                        data: [acima, abaixo],
                        backgroundColor: ['#C7DB9B', '#FF746C']
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Percentual do Quiz'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            precision: 0
                        }
                    }
                }
            });
        }

        function plotarGraficoConselhos(dados) {

            var labels = [];
            var valores = [];

            var personagemMaisVotado = null;
            var maiorQtd = -1;

            for (var i = 0; i < dados.length; i++) {
                var personagem = dados[i].personagem;
                var qtd = dados[i].qtd;

                labels.push(personagem);
                valores.push(qtd);

                if (qtd > maiorQtd) {
                    maiorQtd = qtd;
                    personagemMaisVotado = personagem;
                }
            }

            var kpi3 = document.getElementById("kpiMaisConselho");
            if (kpi3) {
                kpi3.innerHTML = `personagem mais escolhido nos conselhos: ${personagemMaisVotado}`;
            }

            var ctx = document.getElementById('graficoConselhos').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade de conselhos',
                        data: valores,
                        backgroundColor: ['#B2E2F2', '#FABFB7', '#F6C68A']
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Personagem mais conselheiro'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            precision: 0
                        }
                    }
                }
            });
        }

    </script>
</body>

</html>