<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard B612</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        #graficoQuiz2,
        #graficoImagem,
        #graficoConselhos {
            max-width: 300px;
            max-height: 300px;
        }
    </style>

</head>

<body onload="obterDados()">

    <h2>Essência infantil</h2>
    <div id="kpiEssenciaInfantil"></div>
    <canvas id="graficoQuiz2"></canvas>
    <canvas id="graficoImagem"></canvas>
    <canvas id="graficoConselhos"></canvas>

    <span id="b_usuario"></span>

    <script>
        if (sessionStorage.NOME_USUARIO) {
            document.getElementById("b_usuario").innerHTML = sessionStorage.NOME_USUARIO;
        }

        function obterDados() {
            fetch("/dashboard/respostasImagem")
                .then(function (res) {
                    if (!res.ok) {
                        console.log ("Erro ao buscar respostasImagem. Status: " + res.status);
                    }
                    return res.json();
                })
                .then(function (dados) {
                    console.log("Respostas imagem:", dados);
                    plotarGraficoImagem(dados);
                })
                .catch(function (erro) {
                    console.error(erro);
                });

            fetch("/dashboard/quiz2Resumo")
                .then(function (res) {
                    if (!res.ok) {
                        console.log("Erro ao buscar quiz2Resumo: " + res.status);
                    }
                    return res.json();
                })
                .then(function (dados) {
                    console.log("Dados quiz2Resumo (front):", dados);
                    plotarGraficoQuiz2(dados);
                })
                .catch(function (erro) {
                    console.error(erro);
                });

            fetch("/dashboard/conselhosQuiz1")
                .then(function (res) {
                    if (!res.ok) {
                        console.log ("Erro ao buscar conselhosQuiz1: " + res.status);
                    }
                    return res.json();
                })
                .then(function (dados) {
                    console.log("Dados conselhosQuiz1 (front):", dados);
                    plotarGraficoConselhos(dados);
                });
        }

        function plotarGraficoImagem(dados) {
            var canvas = document.getElementById('graficoImagem');
            if (!canvas) {
                console.error("Canvas graficoImagem não encontrado");
                return;
            }

            var ctx = canvas.getContext('2d');

            var labels = [];
            var valores = [];
            var total = 0;
            var qtdJiboia = 0;

            for (var i = 0; i < dados.length; i++) {
                var linha = dados[i];
                labels.push(linha.resposta);
                valores.push(linha.qtd);
                total += linha.qtd;

                if (linha.resposta && linha.resposta.toLowerCase() == "jiboia") {
                    qtdJiboia = linha.qtd;
                }
            }

            var percentual = 0;
            if (total > 0) {
                percentual = ((qtdJiboia / total) * 100).toFixed(1);
            }

            var kpi = document.getElementById("kpiEssenciaInfantil");
            if (kpi) {
                kpi.innerHTML = percentual + "% veem uma jiboia (essência infantil)";
            }

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Respostas da imagem',
                        data: valores
                    }]
                }
            });
        }

        function plotarGraficoQuiz2(dados) {
            console.log("Chegou no plotarGraficoQuiz2:", dados);

            var acima = Number(dados.acima50 || 0);
            var abaixo = Number(dados.abaixo50 || 0);

            console.log("Valores usados no gráfico – acima:", acima, "abaixo:", abaixo);

            var canvas = document.getElementById('graficoQuiz2');

            var ctx = canvas.getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Acima de 50%', 'Abaixo de 50%'],
                    datasets: [{
                        label: 'Quantidade de usuários',
                        data: [acima, abaixo],
                        backgroundColor: ['#4CAF50', '#F44336']
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            precision: 0
                        }
                    }
                }
            });
        }

        function plotarGraficoConselhos(dados) {

            var labels = [];
            var valores = [];

            for (var i = 0; i < dados.length; i++) {
                labels.push(dados[i].personagem);
                valores.push(dados[i].qtd);
            }

            var ctx = document.getElementById('graficoConselhos').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade de usuários',
                        data: valores,
                        backgroundColor: ['#FF9800', '#E91E63', '#3F51B5']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

    </script>
</body>

</html>